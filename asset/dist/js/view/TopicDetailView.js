define(["backbone","model/TopicModel","model/session","text!template/topicDetail.html","util"],function(e,t,n,r,i){var s=i.template(r),o=e.View.extend({template:_.template(s.item("body-template")),events:{"click .js-back":"backList"},initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()))},backList:function(){history.back()}}),u=e.View.extend({template:_.template(s.item("side-template")),events:{"click .js-vote":"toggleVote","click .js-like":"toggleLike"},initialize:function(){this.model.on("change:votes",this.render,this),this.model.on("change:likes",this.render,this),this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()))},toggleLike:function(){n.auth()&&this.model.toggleLike()},toggleVote:function(){n.auth()&&this.model.toggleVote()}}),a=e.View.extend({template:_.template(s.item("comment-template")),className:"media comment",events:{"click .js-reply":"reply","click .js-delete":"delete"},initialize:function(){this.model.on("destroy",this.removeAnimate,this)},render:function(){var e=this.model.toJSON();return e.user.id===n.id?e.isDelete=!0:e.isDelete=!1,this.$el.html(this.template(e)),this.el},reply:function(){if(!n.auth())return;var e=$(".js-comment-text"),t=e.val();e.val(t+(t?"\n":"")+"@"+this.model.get("user").username+" ").focus()},removeAnimate:function(){this.$el.fadeOut(300,_.bind(this.remove,this))},"delete":function(){this.model.destroy().done(function(){i.alert.done("Comment delete successfully")})}}),f=e.View.extend({events:{"click .js-comment":"addComment"},initialize:function(){this.$list=this.$(".comments-list"),this.collection.on("add",this.addOne,this),this.render()},render:function(){this.collection.forEach(this.addOne,this),n.isGuest()?this.$el.append(s.item("alert-login-template")):this.$el.append(_.template(s.item("comment-form-template"),n.toJSON()))},addOne:function(e){this.$list.append((new a({model:e})).render())},addComment:function(){i.alert.load("Sending");var e=this.$("[name=comment-text]");this.collection.create({body:$.trim(e.val())},{wait:!0,success:function(){i.alert.hide()}}),e.val("")}}),l=e.View.extend({el:$("#main"),initialize:function(e){this.model=new t(e),this.model.on("sync",this.render,this),this.model.fetch()},render:function(){this.$el.html(s.item("layout-template"));var e=this.model;new o({el:this.$(".topic-body"),model:e}),new u({el:this.$(".aside"),model:e}),new f({el:this.$(".comments"),collection:e.get("comments")}),$(document).scrollTop(0)}});return l});